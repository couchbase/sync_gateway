# Copyright 2024-Present Couchbase, Inc.
#
# Use of this software is governed by the Business Source License included
# in the file licenses/BSL-Couchbase.txt.  As of the Change Date specified
# in that file, in accordance with the Business Source License, use of this
# software will be governed by the Apache License, Version 2.0, included in
# the file licenses/APL2.txt.
parameters:
  - $ref: ../../components/parameters.yaml#/keyspace
post:
  summary: Dry-run Import filter for testing
  description: |-
    Runs a document through the import filter and return whether its imported or not, and any error messages.

    If no custom import filter is provided in the request body, the default or user-defined import filter is used.

    The document being run through the import filter can be provided in one of the following ways:
    | `doc` property | `doc_id` property | Behaviour                                                                                                                                                            |
    | ------ |----- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | Set   | Unset | The document body passed will be the `doc` value in the function.                                                                                                                         |
    | Unset | Set   | The document of the given id will be fetched from the bucket/collection and will be passed in as the `doc` value in the function. If the document is not found, an error will be returned |
    | Set   | Set   | Will throw an error (only one of `doc` or `doc_id` is allowed for the import filter dry run)                                                                                              |
    | Unset | Unset | Will throw an error (at least one of `doc` or `doc_id` is required)                                                                                                                       |

    * Sync Gateway Application Read Only
  requestBody:
    content:
      application/json:
        schema:
          type: object
          properties:
            doc_id:
              description: An existing document ID to run the dry-run operation against.
              type: string
              example: doc1
            import_filter:
              description: |-
                A JavaScript function that all imported documents in the
                default scope and collection are ran through in order to filter
                out what to import and what not to import.
              type: string
              example: 'function(doc) { if (doc.type != ''mobile'') { return false; } return true; }'
            doc:
              description: A new document body to run the dry-run operation against.
              type: object
              additionalProperties: true
              example:
                foo: bar
  responses:
    '200':
      description: Document Processed by import filter successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              shouldImport:
                description: Whether this document would be imported after being processed by the import filter.
                type: boolean
              exception:
                $ref: ../../components/schemas.yaml#/DiagnosticFunctionException
              logging:
                $ref: ../../components/schemas.yaml#/DiagnosticFunctionLogging
    '404':
      $ref: ../../components/responses.yaml#/Not-found
  tags:
    - Document
  operationId: get_keyspace-import_filter
