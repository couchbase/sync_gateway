# Copyright 2024-Present Couchbase, Inc.
#
# Use of this software is governed by the Business Source License included
# in the file licenses/BSL-Couchbase.txt.  As of the Change Date specified
# in that file, in accordance with the Business Source License, use of this
# software will be governed by the Apache License, Version 2.0, included in
# the file licenses/APL2.txt.
parameters:
  - $ref: ../../components/parameters.yaml#/keyspace
post:
  summary: Dry-run Sync Function for testing
  description: |-
    Runs a document through the Sync Function and returns the result.

    If no custom sync function is provided in the request, the user-defined sync function for the collection is used (or the default).

    The document being run through the sync function can be provided in one of the following ways:
    | `doc` property | `oldDoc` property | `doc_id` property | Behaviour                                                                                                                                                                                               |
    | ----- | ------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | Set   | Unset   | Unset    | The document body passed will be the `doc` value in the sync function, and `oldDoc` will be empty.                                                                                                                        |
    | Set   | Set     | Unset    | The document body passed will be the `doc` value in the sync function, and the `oldDoc` value will be set to the inline `oldDoc` request body.                                                                              |
    | Unset | Unset   | Set      | The document of the given id will be fetched from the bucket/collection and will be passed in as the `doc` value in the sync function. If the document is not found, an error will be returned                            |
    | Set   | Unset   | Set      | The document body passed will be the `doc` value in the sync function, and the `doc_id` will be fetched from the bucket/collection and will be the `oldDoc` value. If `doc_id` doesn't exist, then `oldDoc` will be empty |
    | Unset | -       | Unset    | Will throw an error (at least one of `doc` or `doc_id` is required)                                                                                                                                                       |
    | -     | Set     | Set      | Will throw an error (`doc_id` and inline `oldDoc` cannot both be specified)                                                                                                                                                |

    * Sync Gateway Application Read Only
  requestBody:
    content:
      application/json:
        schema:
          type: object
          properties:
            doc_id:
              description: An existing document ID to run the dry-run operation against.
              type: string
              example: doc1
            sync_function:
              description: |-
                A JavaScript function that defines custom access, channel, and
                validation logic for documents. This function will be evaluated
                by the Sync Gateway to determine document routing, access
                grants, and validation outcomes during synchronization.
              type: string
              example: |-
                function (doc, oldDoc, meta) {
                  channel(doc.channels);
                }
            doc:
              description: A document body to run the sync function dry-run operation against.
              type: object
              additionalProperties: true
              example:
                foo: buzz
                doc_num_updates: 2
            oldDoc:
              description: A document body to use as `oldDoc` during the dry-run. Cannot be used with `doc_id`.
              type: object
              additionalProperties: true
              example:
                foo: bar
                doc_num_updates: 1
            meta:
              description: Optional metadata used during evaluation.
              type: object
              properties:
                xattrs:
                  maximum: 1
                  description: |-
                    Optional XATTR values to include during evaluation.

                    To provide the user XATTR, include a property whose name exactly matches the configured `user_xattr_key`.
                  type: object
                  properties:
                    user_xattr_key:
                      description: The user XATTR JSON value. The property name must exactly match the configured `user_xattr_key`. The value can be any valid JSON type (Object, String, Number, etc.)
                      oneOf:
                        - type: object
                          additionalProperties: true
                          example:
                            foo: bar
                          description: An object value to be used as the user XATTR.
                        - type: string
                          example: foo
                          description: A string value to be used as the user XATTR.
                        - type: integer
                          example: 100
                          description: A number value to be used as the user XATTR.
                        - type: boolean
                          example: true
                          description: A boolean value to be used as the user XATTR.
                        - type: array
                          items:
                            example:
                              - foo
                              - bar
                            description: An array of values to be used as the user XATTR.
            userCtx:
              description: |-
                Optional user context used during evaluation. Can be used to test a document update as a non-admin user. Used by Sync Function utilities `requireUser()`, `requireRole()`, `requireAccess()`, etc.

                The user, channels and roles do not have to exist in the system to be declared here. The Sync Function dry-run will be evaluated as though they do exist.

                If this `userCtx` is not provided, the sync function will be evaluated as an admin user (e.g. Admin API writes, Import, Resync, etc.)
              type: object
              properties:
                name:
                  type: string
                  description: The name of the user to run as. The user does not have to exist. Used by `requireUser()`.
                  example: user1
                roles:
                  type: array
                  items:
                    type: string
                  description: A set of roles the user has. The roles do not have to exist. Used by `requireRole()`.
                  example:
                    - role1
                    - role2
                channels:
                  type: array
                  items:
                    type: string
                  description: A set of channels the user has (*including those inherited from their roles*). Used by `requireAccess()`.
                  example:
                    - channel1
                    - channel2
  responses:
    '200':
      description: Document Processed by sync function successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              channels:
                description: A list of channels the document was placed in by the sync function.
                type: array
                example:
                  - channel1
                  - channel2
              roles:
                description: An access map of dynamic roles granted by the sync function. The properties are the usernames and the values are an array of roles.
                type: object
                additionalProperties:
                  x-additionalPropertiesName: username
                  example: ["role1", "role2"]
                  type: array
                  items:
                    type: string
                    example: role1
              access:
                description: An access map of dynamic channels granted by the sync function. The properties are the usernames and the values are an array of channels.
                type: object
                additionalProperties:
                  x-additionalPropertiesName: username
                  example: ["channel1", "channel2"]
                  type: array
                  items:
                    type: string
                    example: channel1
              expiry:
                description: The document expiry (TTL in seconds) as determined by the sync function.
                type: number
                example: 300
              exception:
                $ref: ../../components/schemas.yaml#/DiagnosticFunctionException
              logging:
                $ref: ../../components/schemas.yaml#/DiagnosticFunctionLogging
    '404':
      $ref: ../../components/responses.yaml#/Not-found
  tags:
    - Document
  operationId: get_keyspace-sync
