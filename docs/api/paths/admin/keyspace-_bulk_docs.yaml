# Copyright 2022-Present Couchbase, Inc.
#
# Use of this software is governed by the Business Source License included
# in the file licenses/BSL-Couchbase.txt.  As of the Change Date specified
# in that file, in accordance with the Business Source License, use of this
# software will be governed by the Apache License, Version 2.0, included in
# the file licenses/APL2.txt.
parameters:
  - $ref: ../../components/parameters.yaml#/keyspace
post:
  summary: Bulk document operations
  description: |-
    This will allow multiple documented to be created, updated or deleted in bulk.

    To create a new document, simply add the body in an object under `docs`. A doc ID will be generated by Sync Gateway unless `_id` is specified.

    To update an existing document, provide the document ID (`_id`) and revision ID (`_rev`) as well as the new body values.

    To delete an existing document, provide the document ID (`_id`), revision ID (`_rev`), and set the deletion flag (`_deleted`) to true.

    Required Sync Gateway RBAC roles:

    * Sync Gateway Application
  requestBody:
    content:
      application/json:
        schema:
          type: object
          properties:
            new_edits:
              description: This controls whether to assign new revision identifiers to new edits (`true`) or use the existing ones (`false`).
              type: boolean
              default: true
            docs:
              type: array
              items:
                $ref: ../../components/schemas.yaml#/Document
          required:
            - docs
        example:
          new_edits: true
          docs:
            - _id: FooBar
              foo: bar
            - _id: AliceSettings
              _rev: 5-832a6db48ed130adadede928aee54576
              FailedLoginAttempts: 7
            - _id: BobSettings
              _rev: 1-fa76ba41ee5fdfee1b91fc478ed09e59
              _deleted: true
  responses:
    '201':
      description: |-
        Executed all operations.

        Each object in the returned array represents a document. Each document should be checked to make sure it was successfully added to the database.
      content:
        application/json:
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  description: The ID of the document that the operation was performed on.
                  type: string
                rev:
                  description: The new revision of the document if the operation was a success.
                  type: string
                error:
                  description: The error type if the operation of the document failed.
                  type: string
                reason:
                  description: The reason the operation failed.
                  type: string
                status:
                  description: The HTTP status code for why the operation failed.
                  type: integer
              required:
                - id
            uniqueItems: true
          examples:
            Success:
              value:
                - id: FooBar
                  rev: 1-cd809becc169215072fd567eebd8b8de
                - id: AliceSettings
                  rev: 6-b3e8dcf825b71ccee112f3572ec4323c
                - id: BobSettings
                  rev: 2-5145e1086bb8d1d71a531e9f6b543c58
            Partial success:
              value:
                - error: conflict
                  id: FooBar
                  reason: Document exists
                  status: 409
                - id: AliceSettings
                  rev: 6-b3e8dcf825b71ccee112f3572ec4323c
                - error: conflict
                  id: BobSettings
                  reason: Document revision conflict
                  status: 409
    '400':
      $ref: ../../components/responses.yaml#/request-problem
    '404':
      $ref: ../../components/responses.yaml#/Not-found
  tags:
    - Document
  operationId: post_keyspace-_bulk_docs
